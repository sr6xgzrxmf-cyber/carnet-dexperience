"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";

type Linked = { href: string; exists: boolean };

type Item = {
  slug: string;
  title: string;
  date: string | null;
  seriesName: string | null;
  seriesSlug: string | null;
  seriesOrder: number | null;
  tags: string[];
  excerpt: string | null;
  cover: string | null;
  coverOk: boolean;
  coverExpected: string;
  coverExpectedOk: boolean;
  linked: Linked[];
  brief: string;
  da: string;
  problems: string[];

  // ✅ Ajouts Batch 1 (fallback si absent)
  expectedBasename?: string; // nom fichier sans extension
  daPrompt?: string; // DA fixe + brief
};

type CopyEvent = {
  ts: number;
  slug: string;
  kind: "basename" | "daPrompt";
  value: string;
};

const HISTORY_KEY = "ce_editor_copy_history_v1";

function isLocalHost() {
  if (typeof window === "undefined") return true;
  return window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
}

function loadHistory(): CopyEvent[] {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  } catch {
    return [];
  }
}

function pushHistory(evt: CopyEvent): CopyEvent[] {
  const prev = loadHistory();
  const next = [evt, ...prev].slice(0, 50);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(next));
  return next;
}

async function copyToClipboard(text: string) {
  await navigator.clipboard.writeText(text);
}

export default function ControleEditorialPage() {
  const [items, setItems] = useState<Item[]>([]);
  const [q, setQ] = useState("");
  const [onlyProblems, setOnlyProblems] = useState(true);
  const [selected, setSelected] = useState<Item | null>(null);

  // ✅ feedback + historique
  const [copiedKey, setCopiedKey] = useState<string>("");
  const [history, setHistory] = useState<CopyEvent[]>([]);

  async function refresh() {
    const res = await fetch("/api/articles/audit");
    if (!res.ok) return;
    const json = await res.json();
    setItems(json.items ?? []);
  }

  useEffect(() => {
    refresh();
  }, []);

  useEffect(() => {
    setHistory(loadHistory());
  }, []);

  const local = isLocalHost();

  const filtered = useMemo(() => {
    const qq = q.trim().toLowerCase();
    return items.filter((it) => {
      if (onlyProblems && it.problems.length === 0) return false;
      if (!qq) return true;
      return (
        it.slug.toLowerCase().includes(qq) ||
        it.title.toLowerCase().includes(qq) ||
        (it.seriesSlug ?? "").toLowerCase().includes(qq) ||
        (it.seriesName ?? "").toLowerCase().includes(qq) ||
        (it.tags ?? []).join(" ").toLowerCase().includes(qq)
      );
    });
  }, [items, q, onlyProblems]);

  async function copyBasename(it: Item) {
    const basename = (it.expectedBasename ?? it.slug).trim();
    await copyToClipboard(basename);
    setCopiedKey(`basename:${it.slug}`);
    setHistory(
      pushHistory({
        ts: Date.now(),
        slug: it.slug,
        kind: "basename",
        value: basename,
      })
    );
    window.setTimeout(() => setCopiedKey(""), 1200);
  }

  async function copyDABrief(it: Item) {
    const value = (it.daPrompt ?? it.da ?? "").trim();
    if (!value) return;
    await copyToClipboard(value);
    setCopiedKey(`da:${it.slug}`);
    setHistory(
      pushHistory({
        ts: Date.now(),
        slug: it.slug,
        kind: "daPrompt",
        value,
      })
    );
    window.setTimeout(() => setCopiedKey(""), 1200);
  }

  return (
    <div style={{ padding: 24 }}>
      {!local && (
        <div
          style={{
            marginBottom: 16,
            padding: 12,
            borderRadius: 12,
            background: "rgba(255, 193, 7, 0.15)",
            border: "1px solid rgba(255, 193, 7, 0.35)",
          }}
        >
          <strong>Outil éditorial local.</strong> Ce contrôle lit les fichiers du disque : il n’est pas fait pour la production.
        </div>
      )}

      <div style={{ display: "flex", alignItems: "end", justifyContent: "space-between", gap: 12, marginBottom: 14 }}>
        <div>
          <h1 style={{ fontSize: 28, fontWeight: 700, margin: 0 }}>Contrôle éditorial</h1>
          <div style={{ opacity: 0.75, marginTop: 4 }}>Covers, séries, dates, fichiers liés, brief DA.</div>
        </div>

        <button
          onClick={() => refresh()}
          style={{ padding: "10px 14px", borderRadius: 12, border: "1px solid rgba(0,0,0,0.18)", background: "white" }}
        >
          Rafraîchir
        </button>
      </div>

      <div style={{ display: "flex", gap: 12, alignItems: "center", marginBottom: 14 }}>
        <input
          value={q}
          onChange={(e) => setQ(e.target.value)}
          placeholder="Rechercher (titre, slug, série, tags)…"
          style={{ flex: 1, padding: 10, borderRadius: 12, border: "1px solid rgba(0,0,0,0.18)" }}
        />
        <label style={{ display: "flex", gap: 8, alignItems: "center", userSelect: "none" }}>
          <input type="checkbox" checked={onlyProblems} onChange={(e) => setOnlyProblems(e.target.checked)} />
          Problèmes seulement
        </label>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: selected ? "1fr 420px" : "1fr", gap: 16, alignItems: "start" }}>
        <div
          style={{
            border: "1px solid rgba(0,0,0,0.08)",
            borderRadius: 14,
            overflow: "hidden",
            background: "white",
          }}
        >
          <div style={{ padding: 12, borderBottom: "1px solid rgba(0,0,0,0.08)", fontWeight: 700 }}>
            Articles ({filtered.length})
          </div>

          <div style={{ overflowX: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead>
                <tr style={{ background: "rgba(0,0,0,0.03)" }}>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Date</th>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Titre</th>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Série</th>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Cover</th>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Liens</th>
                  <th style={{ textAlign: "left", padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>Problèmes</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((it) => {
                  const missingLinks = it.linked.filter((l) => !l.exists).length;
                  const coverStatus = it.cover
                    ? it.coverOk
                      ? "OK"
                      : "introuvable"
                    : it.coverExpectedOk
                      ? "manquante (fichier existe)"
                      : "manquante";

                  return (
                    <tr
                      key={it.slug}
                      onClick={() => setSelected(it)}
                      style={{
                        cursor: "pointer",
                        background: selected?.slug === it.slug ? "rgba(0,0,0,0.04)" : "transparent",
                      }}
                    >
                      <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)", whiteSpace: "nowrap" }}>
                        {it.date ?? "—"}
                      </td>
                      <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>
                        <div style={{ fontWeight: 650 }}>{it.title}</div>
                        <div style={{ opacity: 0.6, fontSize: 12 }}>{it.slug}</div>
                      </td>
                     <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>
  {it.seriesSlug ? (
    <div>
      <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
        <div style={{ fontWeight: 600 }}>{it.seriesName ?? it.seriesSlug}</div>

        <Link
          href={`/admin/series/${it.seriesSlug}`}
          onClick={(e) => e.stopPropagation()}
          style={{ fontSize: 12, opacity: 0.85, textDecoration: "underline" }}
          title="Ouvrir la série (admin)"
        >
          ouvrir →
        </Link>
      </div>

      <div style={{ opacity: 0.7, fontSize: 12 }}>
        {it.seriesSlug}
        {it.seriesOrder != null ? ` — ${it.seriesOrder}` : ""}
      </div>
    </div>
  ) : (
    <span style={{ opacity: 0.7 }}>Hors série</span>
  )}
</td>
                      <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>{coverStatus}</td>
                      <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>
                        {it.linked.length ? (
                          <span>{missingLinks ? `${missingLinks} manquant(s)` : "OK"}</span>
                        ) : (
                          <span style={{ opacity: 0.7 }}>—</span>
                        )}
                      </td>
                      <td style={{ padding: 10, borderBottom: "1px solid rgba(0,0,0,0.06)" }}>
                        {it.problems.length ? it.problems.join(" · ") : <span style={{ opacity: 0.7 }}>—</span>}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>

        {selected && (
          <aside
            style={{
              position: "sticky",
              top: 16,
              alignSelf: "start",
              border: "1px solid rgba(0,0,0,0.08)",
              borderRadius: 14,
              padding: 14,
              background: "white",
              maxHeight: "85vh",
              overflow: "auto",
            }}
          >
            <div style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "center" }}>
              <div style={{ fontWeight: 800 }}>{selected.title}</div>
              <button
                onClick={() => setSelected(null)}
                style={{ padding: "8px 10px", borderRadius: 10, border: "1px solid rgba(0,0,0,0.18)", background: "white" }}
              >
                Fermer
              </button>
            </div>

            <div style={{ opacity: 0.7, marginTop: 4, marginBottom: 12 }}>{selected.slug}</div>

            <div style={{ display: "grid", gap: 10 }}>
              <div>
                <div style={{ fontWeight: 700 }}>Cover</div>
                <div style={{ fontSize: 13, marginTop: 4 }}>
                  Référencée : <code>{selected.cover ?? "—"}</code>
                  <br />
                  <span style={{ opacity: 0.65 }}>Nom attendu :</span>{" "}
                  <code>{(selected.expectedBasename ?? selected.slug) + ".jpg"}</code>
                </div>

                <div style={{ marginTop: 10, display: "flex", gap: 8, flexWrap: "wrap" }}>
                  <button
                    onClick={() => copyBasename(selected)}
                    style={{
                      padding: "10px 12px",
                      borderRadius: 12,
                      border: "1px solid rgba(0,0,0,0.18)",
                      background: "rgba(0,0,0,0.04)",
                    }}
                    type="button"
                  >
                    {copiedKey === `basename:${selected.slug}` ? "Copié ✓" : "Copier le nom du fichier"}
                  </button>
                </div>

                <div style={{ marginTop: 6, opacity: 0.8 }}>
                  {selected.cover
                    ? selected.coverOk
                      ? "✅ Fichier présent"
                      : "❌ Fichier introuvable"
                    : selected.coverExpectedOk
                      ? "⚠️ Cover manquante (mais un fichier attendu existe)"
                      : "⚠️ Cover manquante"}
                </div>
              </div>

              <div>
                <div style={{ fontWeight: 700 }}>Fichiers liés</div>
                {selected.linked.length ? (
                  <div style={{ display: "grid", gap: 6, marginTop: 6, fontSize: 13 }}>
                    {selected.linked.map((l) => (
                      <div key={l.href} style={{ display: "flex", justifyContent: "space-between", gap: 8 }}>
                        <code style={{ wordBreak: "break-all" }}>{l.href}</code>
                        <span>{l.exists ? "✅" : "❌"}</span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div style={{ opacity: 0.7, marginTop: 6 }}>Aucun lien d’asset détecté.</div>
                )}
              </div>

              <div>
                <div style={{ fontWeight: 700 }}>Brief (pour la DA)</div>
                <div style={{ fontSize: 13, marginTop: 6, opacity: 0.85 }}>{selected.brief || "—"}</div>

                <button
                  onClick={() => copyDABrief(selected)}
                  style={{
                    marginTop: 10,
                    padding: "10px 12px",
                    borderRadius: 12,
                    border: "1px solid rgba(0,0,0,0.18)",
                    background: "rgba(0,0,0,0.04)",
                  }}
                  type="button"
                >
                  {copiedKey === `da:${selected.slug}` ? "Copié ✓" : "Copier le brief DA"}
                </button>

                {/* Petit hint si Batch 1 n'est pas encore branché */}
                {!selected.daPrompt && (
                  <div style={{ marginTop: 8, fontSize: 12, opacity: 0.65 }}>
                    Astuce : applique le Batch 1 pour copier la DA complète (DA fixe + brief). Pour l’instant, copie la fiche courte.
                  </div>
                )}
              </div>

              <div style={{ paddingTop: 8, borderTop: "1px solid rgba(0,0,0,0.08)" }}>
                <div style={{ fontWeight: 700 }}>Historique</div>

                {history.length === 0 ? (
                  <div style={{ opacity: 0.7, marginTop: 6, fontSize: 13 }}>Aucune copie pour le moment.</div>
                ) : (
                  <div style={{ display: "grid", gap: 8, marginTop: 8 }}>
                    {history.slice(0, 12).map((h, idx) => (
                      <div key={`${h.ts}-${idx}`} style={{ border: "1px solid rgba(0,0,0,0.08)", borderRadius: 12, padding: 10 }}>
                        <div style={{ display: "flex", justifyContent: "space-between", gap: 10, alignItems: "center" }}>
                          <div style={{ fontSize: 12, opacity: 0.7 }}>
                            {new Date(h.ts).toLocaleString("fr-FR")} ·{" "}
                            <span style={{ fontWeight: 700 }}>{h.kind === "basename" ? "Nom" : "DA"}</span>
                          </div>

                          <button
                            onClick={async () => {
                              await copyToClipboard(h.value);
                              setCopiedKey(`hist:${idx}`);
                              window.setTimeout(() => setCopiedKey(""), 900);
                            }}
                            style={{
                              padding: "6px 10px",
                              borderRadius: 10,
                              border: "1px solid rgba(0,0,0,0.18)",
                              background: "white",
                              fontSize: 12,
                            }}
                            type="button"
                          >
                            {copiedKey === `hist:${idx}` ? "Copié ✓" : "Re-copier"}
                          </button>
                        </div>

                        <div style={{ marginTop: 6, fontSize: 12 }}>
                          <div style={{ opacity: 0.7, marginBottom: 4 }}>{h.slug}</div>
                          <code style={{ display: "block", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                            {h.value}
                          </code>
                        </div>
                      </div>
                    ))}

                    <button
                      onClick={() => {
                        localStorage.removeItem(HISTORY_KEY);
                        setHistory([]);
                      }}
                      style={{
                        padding: "10px 12px",
                        borderRadius: 12,
                        border: "1px solid rgba(0,0,0,0.18)",
                        background: "white",
                      }}
                      type="button"
                    >
                      Vider l’historique
                    </button>
                  </div>
                )}
              </div>

              {selected.problems.length > 0 && (
                <div style={{ padding: 10, borderRadius: 12, background: "rgba(255,0,0,0.06)", border: "1px solid rgba(255,0,0,0.12)" }}>
                  <div style={{ fontWeight: 800, marginBottom: 6 }}>À corriger</div>
                  <div style={{ fontSize: 13 }}>{selected.problems.join(" · ")}</div>
                </div>
              )}
            </div>
          </aside>
        )}
      </div>
    </div>
  );
}
